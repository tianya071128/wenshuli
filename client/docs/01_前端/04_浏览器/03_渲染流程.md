---
title: 渲染流程
date: 2021-10-21 15:00:00
permalink: /browser/render
categories:
  - 前端
  - 浏览器
tags:
  - null
---

# 渲染流程

渲染流程过于复杂，所以渲染模块将执行过程分为很多子阶段，输入的 HTML 数据经过这些子阶段，最后输出像素。这一过程叫做**渲染流水线**，其大致流程如下图：

![img](/img/102.png)

按照渲染的顺序，可分为如下几个阶段：**构建 DOM 树、样式计算、布局阶段、分层、绘制、分块、光栅化和合成**。每个阶段重点关注以下三个内容：

* 开始每个子阶段都有其**输入内容**；
* 然后每个子阶段有其**处理过程**；
* 最终每个子阶段会生成**输出内容**。

## 构建 DOM 树

浏览器无法直接理解和使用 HTML，所以需要将 HTML 转换为可理解的结构 —— DOM 树。

* 输入内容：非常简单的 HTML 文件

* 处理过程：由 HTML 解析器解析，**注意的是这个会解析出所有的 HTML 结构，包含了可见和不可见的元素的**

* 输出内容：树状结构的 DOM，是保存在**内存中树状数据结构**，在 js 中可通过 `document` 访问

![img](/img/103.png)

## 样式计算（Recalculate Style）

样式计算是为了计算出 DOM 节点中每个元素的具体样式：

* 输入内容：CSS 的来源主要有以下三个：

  * 通过 link 引用的外部 CSS 文件
  * 通过 link 引用的外部 CSS 文件
  * 元素的 style 属性内嵌的 CSS

* 处理过程：大体分为以下三步完成：

  * 将 CSS 转换为浏览器可以理解的结构 —— `styleSheets`，在 js 中可通过 `document.styleSheets` 访问

  * 转换样式表中的属性值，使其标准化。需要将所有值(如 2em、blue、bold)转换为渲染引擎容易理解的、标准化的计算值，这个过程就是属性值标准化。

    ![img](/img/104.png)

  * 根据 CSS 的继承规则和层叠规则计算 DOM 树中每个节点的样式属性

* 输出内容：每个 DOM 节点的样式，并被保存在 ComputedStyle 的结构内。

![image-20220517105907083](/img/105.png)

## 布局阶段 -构建布局树(LayoutTree)

接下来需要**计算出 DOM 树中可见元素的几何位置，我们把这个计算过程叫做布局。**

* 输入内容：DOM 树 和 DOM 样式结构树(ComputedStyle)

* 处理过程：主要有两个任务，**创建布局树和布局计算**。

  * 创建布局树：DOM 中含有很多不可见的元素(head 标签、display:none 属性的元素等)，所以**需要构建一棵只包含可见元素布局树(DOM 树中所有不可见的节点都没有包含到布局树中)**。在构建布局树过程中浏览器大致完成了如下工作：

    * 遍历 DOM 树中的所有可见节点，并把这些节点加到布局树中；
    * 不可见的节点会被布局树忽略掉，如 head 标签、display:none 属性的元素等

    ![img](/img/106.png)

  * 布局计算：根据布局树，计算布局树节点的坐标位置了，**把布局运算的结果重新写回布局树中**。

* 输出内容：包含节点布局信息的布局树

## 分层 - 构建图层树(LayerTree)

页面中有些复杂的效果(如一些复杂的 3D 变换、页面滚动，或者使用 z-indexing 做 z 轴排序等)，为了实现这些效果，**渲染引擎还需要为特定的节点生成专用的图层，并生成一棵对应的图层树**。

* 输入内容：布局阶段生成的布局树。
* 处理过程：浏览器页面会被分成很多图层，这些图层叠加后合成了最终的页面。通常情况下，并不是布局树的每个节点都包含一个图层，如果一个节点没有对应的层，那么这个节点就从属于父节点的图层。**但不管怎样，最终每一个节点都会直接或者间接地从属于一个层。**
* 输出内容：图层树(LayerTree)

![img](/img/107.png)

::: warning 什么条件会创建图层

在 [极客时间-渲染流程](https://time.geekbang.org/column/article/118826) 这篇文章中的条件存在错误(也可能是浏览器更新的问题)，目前而言，浏览器会更智能的创建图层。

* 拥有层叠上下文的条件，并且满足一定条件(这个条件暂不得知，应该是位置会发生变化时)
  * 例如固定定位(`position: fixed;`)时，触发一定条件
  * 例如发生动画时
  * 。。。
* 节点可滚动时(`overflow`)，即存在滚动条，并且还需要满足一定条件(测试存在背景颜色时)，会生成单独图层
* 指定 `will-change` 属性告知浏览器这个节点需要生成单独图层

<a href="/html/layers.html" target="_blank">这个链接有一些会生成图层的例子</a>，打开 `devtools` 的 `layers(图层)` 选项卡可查看

:::









